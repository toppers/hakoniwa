<!doctype html><html lang=ja><head><meta name=generator content="Hugo 0.122.0"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>制御プログラムの変更方法 </title><meta name=description content="[Getting Started 1] tb3の制御プログラムの変更方法を紹介します"><meta name=author content="TOPPERS Project Hakoniwa WG"><meta property="og:title" content="制御プログラムの変更方法"><meta property="og:description" content="[Getting Started 1] tb3の制御プログラムの変更方法を紹介します"><meta property="og:type" content="article"><meta property="og:url" content="https://toppers.github.io/hakoniwa/getting-started/app-customize/"><meta property="og:image" content="https://toppers.github.io/hakoniwa/img/hakoniwa/icon-310x310.png"><meta property="article:section" content="getting-started"><meta property="article:published_time" content="2022-05-14T13:26:38+09:00"><meta property="article:modified_time" content="2022-05-14T13:26:38+09:00"><meta name=twitter:card content="summary"><meta name=twitter:site content="@toppersjp"><meta property="fb:app_id" content="3035581286538848"><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-169187702-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=canonical href=https://toppers.github.io/hakoniwa/getting-started/app-customize/><link rel=icon type=image/png href=/hakoniwa/img/hakoniwa/favicon-32x32.png><link href=/hakoniwa/css/font.css rel=stylesheet type=text/css><link href=/hakoniwa/css/kube.min.css rel=stylesheet type=text/css><link href=/hakoniwa/css/kube.legenda.css rel=stylesheet type=text/css><link href=/hakoniwa/css/highlight.css rel=stylesheet type=text/css><link href=/hakoniwa/css/main.css rel=stylesheet type=text/css><link href=/hakoniwa/css/custom.css rel=stylesheet type=text/css><script src=/hakoniwa/js/jquery-2.1.4.min.js type=text/javascript></script><script type=text/javascript src=/hakoniwa/js/tocbot.min.js></script></head><body class=page-kube><header><div class=show-sm><div id=nav-toggle-box><div id=nav-toggle-brand><a href=/hakoniwa>箱庭</a></div><a data-component=toggleme data-target=#top href=# id=nav-toggle><i class=kube-menu></i></a></div></div><div class=hide-sm id=top><div id=top-brand><a href=/hakoniwa title=home><img src=/hakoniwa/img/hakoniwa/icon-70x70.png></a></div><nav id=top-nav-main><ul><li><a href=/hakoniwa/docs/>箱庭とは</a></li><li><a href=/hakoniwa/prototypes/>プロトタイプモデル</a></li><li><a href=/hakoniwa/technical-links/>技術情報</a></li><li><a href=/hakoniwa/showcase/>ショーケース</a></li><li><a href=/hakoniwa/tutorial/>チュートリアル</a></li><li><a href=/hakoniwa/repositories/>リポジトリ</a></li><li><a href=/hakoniwa/contact/>SNS・問合せ先</a></li></ul></nav><nav id=top-nav-extra><ul><li><a href=# class="active language">JP</a></li></ul></nav></div></header><main><div id=main><div id=hero><h1>制御プログラムの変更方法</h1><p class=hero-lead>[Getting Started 1] tb3の制御プログラムの変更方法を紹介します.</p></div><div id=kube-component class=content><h3 id=ソースコードの場所>ソースコードの場所</h3><p>今回のサンプルのtb3の制御プログラムは、
<code>/ros2/workspace/src/tb3/src/tb3ctrl.cpp</code> に配置されています。
詳細は実際のコードを見て頂くとして主要な部分を紹介していきます。ページの最後にコードの抜粋を示します。</p><h3 id=制御プログラムの概要>制御プログラムの概要</h3><p>Unity上のロボットと制御プログラムとは、ROSで通信しています。
Unity上のロボットからはレーザースキャナから周囲360°の距離データが送られてきます。制御プログラムからはロボットの移動量を送信します。</p><p>この制御プログラムは、壁沿いに周回するような制御を行っています。do_forwardで前方の距離が一定以上あれば前進し、turn_rightでは右側の距離が一定以上であれば旋回します。</p><p>このように制御部分は非常に小さく、他はROSで通信するためのボイラープレートとなっています。
制御部分のパラメータを変えることで、自由にロボットを制御することができます。いろいろと書き換えて試してみてください。
なお、コードを書き換えた後は、Dockerのコンテナ内でbuild.bashを実行してプログラムのコンパイルを行ってください。</p><h3 id=制御プログラムの抜粋>制御プログラムの抜粋</h3><pre tabindex=0><code>// ロボットのレーザースキャナから受け取る360°周囲の距離データ
typedef struct {
  double ranges[360];
} ScanDataType;
static ScanDataType scan_data;

// レーザースキャナから受け取ったデータのROSのコールバック関数。取得したデータをscan_data変数に保持する。
static void scanCallback(const sensor_msgs::msg::LaserScan::SharedPtr msg) {
  int i;
  for (i = 0; i &lt; 360; i++) {
    scan_data.ranges[i] = msg-&gt;ranges[i];
  }
  return;
}

// Unity上のロボットの制御値
static geometry_msgs::msg::Twist cmd_vel;

static float get_forward_distance(void) {
  ... // 前方向の一定角度のうち一番近い距離を取得
}

static float get_right_distance(void) {
  ... // 右側の一定角度のうち一番近い距離を取得
}

static bool do_forward(void) {
  ... // 前方向に移動指示。cmd_vel.linear.x（前後方向）を増加させ送信
}

static bool turn_right(void) {
  ... // 右転回を指示。cmd_vel.angular.z値(ロボットの垂直軸回転角)を増加して送信
}

static void do_control(void) {
  ... // 周囲の距離に応じて処理を判定する
}

using namespace std::chrono_literals;

int main(int argc, char **argv) {
  char buffer[3][4096];

  // UnityとROSで連携するためのTOPIC名の設定
  if (argc &gt; 1) {
    sprintf(buffer[0], &#34;%s_tb3_node&#34;, argv[1]);
    sprintf(buffer[1], &#34;%s_cmd_vel&#34;, argv[1]);
    sprintf(buffer[2], &#34;%s_scan&#34;, argv[1]);
    printf(&#34;START: %s\n&#34;, argv[1]);
  }
  else {
    sprintf(buffer[0], &#34;tb3_node&#34;);
    sprintf(buffer[1], &#34;cmd_vel&#34;);
    sprintf(buffer[2], &#34;scan&#34;);
    printf(&#34;START\n&#34;);
  }
  rclcpp::init(argc, argv);

  // ROSのPublisher, Subscriberの生成
  auto node = rclcpp::Node::make_shared(buffer[0]);
  auto publisher =
      node-&gt;create_publisher&lt;geometry_msgs::msg::Twist&gt;(buffer[1], 1);
  auto subscriber = node-&gt;create_subscription&lt;sensor_msgs::msg::LaserScan&gt;(
      buffer[2], 1, scanCallback);

  rclcpp::WallRate rate(10ms);

  // 制御ループ
  while (rclcpp::ok()) {
    do_control();
    publisher-&gt;publish(cmd_vel);

    rclcpp::spin_some(node);
    rate.sleep();
  }
  return 0;
}
</code></pre><div class=xPrevNextLink><div class=xPrevNextLink_prev><a href=https://toppers.github.io/hakoniwa/getting-started/architecture-overview/>箱庭のアーキテクチャ</a></div><div class=xPrevNextLink_next><a href=https://toppers.github.io/hakoniwa/getting-started/env-customize/>コースの変更方法</a></div></div><script>document.addEventListener("DOMContentLoaded",function(){var e,t={"#slide-up-btn":{el:"#animation-box-slide-up",to:"slideUp",back:"slideDown"},"#slide-down-btn":{el:"#animation-box-slide-down",to:"slideDown",back:"slideUp"},"#fade-in-btn":{el:"#animation-box-fade-in",to:"fadeIn",back:"fadeOut"},"#fade-out-btn":{el:"#animation-box-fade-out",to:"fadeOut",back:"fadeIn"},"#flip-in-btn":{el:"#animation-box-flip-in",to:"flipIn",back:"flipOut"},"#flip-out-btn":{el:"#animation-box-flip-out",to:"flipOut",back:"flipIn"},"#zoom-in-btn":{el:"#animation-box-zoom-in",to:"zoomIn",back:"zoomOut"},"#zoom-out-btn":{el:"#animation-box-zoom-out",to:"zoomOut",back:"zoomIn"},"#slide-in-right-btn":{el:"#animation-box-slide-in-right",to:"slideInRight",back:"slideOutRight"},"#slide-in-left-btn":{el:"#animation-box-slide-in-left",to:"slideInLeft",back:"slideOutLeft"},"#slide-in-down-btn":{el:"#animation-box-slide-in-down",to:"slideInDown",back:"slideOutUp"},"#slide-out-right-btn":{el:"#animation-box-slide-out-right",to:"slideOutRight",back:"slideInRight"},"#slide-out-left-btn":{el:"#animation-box-slide-out-left",to:"slideOutLeft",back:"slideInLeft"},"#slide-out-up-btn":{el:"#animation-box-slide-out-up",to:"slideOutUp",back:"slideInDown"}};for(e in t)$(e).attr("data-el",t[e].el),$(e).attr("data-to",t[e].to),$(e).attr("data-back",t[e].back),$(e).on("click",function(e){e.preventDefault();var n,t=$(e.target);if(t.hasClass("demo-muted-link"))return;n=$(t.attr("data-el")),t.addClass("demo-muted-link"),n.animation(t.attr("data-to")),setTimeout(function(){n.animation(t.attr("data-back")),t.removeClass("demo-muted-link")},1500)});$("#rotate-btn").on("click",function(e){e.preventDefault(),$("#animation-box-rotate").animation("rotate")}),$("#shake-btn").on("click",function(e){e.preventDefault(),$("#animation-box-shake").animation("shake")}),$("#pulse-btn").on("click",function(e){e.preventDefault(),$("#animation-box-pulse").animation("pulse")})})</script></div></div></main><footer><footer id=footer><nav><ul><li><span>HAKONIWA-WG</span></li></ul></nav><p>&copy; 2019- by Hakoniwa Working-Group, TOPPERS Project</p></footer></footer><script src=/hakoniwa/js/kube.js type=text/javascript></script><script src=/hakoniwa/js/kube.legenda.js type=text/javascript></script><script src=/hakoniwa/js/main.js type=text/javascript></script></body></html>