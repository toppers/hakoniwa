<!doctype html><html lang=ja><head><meta name=generator content="Hugo 0.111.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>単体ロボット向けシミュレータ導入手順</title><meta name=author content="TOPPERS Project Hakoniwa WG"><meta property="og:title" content="単体ロボット向けシミュレータ導入手順"><meta property="og:description" content="EV3ロボット制御プログラム 現時点の制御プログラムの開発フォルダは以下のフォルダで，制御プログラムは app.c です．
※まだ暫定構成です．
ARM版のathrill2を利用される場合は，以下のフォルダで作業してください．
$ ls ev3rt-athrill-ARMv7-A/sdk/OBJ1.1/app.c app.h device_config_mmap.txt Makefile memory_mmap.txt simstart.bashapp.cfg athrill_mmap.bin device_config.txt Makefile.inc memory.txt unity_mmap.bin 現状は，app.c/main_task で直接制御を行っています．
コード断片は以下の通りです．
while(1) {/*** PID controller*/#define white 100#define black 50static float lasterror = 0, integral = 0;static float midpoint = (white - black) / 2 + black;{float error = midpoint - ev3_color_sensor_get_reflect(EV3_PORT_1);integral = error + integral * 0.3;float steer = 0."><meta property="og:type" content="article"><meta property="og:url" content="https://toppers.github.io/hakoniwa/single-robot-setup-detail/51_ev3rt_app_introduction_arm/"><meta property="og:image" content="https://toppers.github.io/hakoniwa/img/hakoniwa/icon-310x310.png"><meta property="article:section" content="single-robot-setup-detail"><meta name=twitter:card content="summary"><meta name=twitter:site content="@toppersjp"><meta property="fb:app_id" content="3035581286538848"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-169187702-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=canonical href=https://toppers.github.io/hakoniwa/single-robot-setup-detail/51_ev3rt_app_introduction_arm/><link rel=icon type=image/png href=/hakoniwa/img/hakoniwa/favicon-32x32.png><link href=/hakoniwa/css/font.css rel=stylesheet type=text/css><link href=/hakoniwa/css/kube.min.css rel=stylesheet type=text/css><link href=/hakoniwa/css/kube.legenda.css rel=stylesheet type=text/css><link href=/hakoniwa/css/highlight.css rel=stylesheet type=text/css><link href=/hakoniwa/css/main.css rel=stylesheet type=text/css><link href=/hakoniwa/css/custom.css rel=stylesheet type=text/css><script src=/hakoniwa/js/jquery-2.1.4.min.js type=text/javascript></script><script type=text/javascript src=/hakoniwa/js/tocbot.min.js></script></head><body class=page-kube><header><div class=show-sm><div id=nav-toggle-box><div id=nav-toggle-brand><a href=/hakoniwa>箱庭</a></div><a data-component=toggleme data-target=#top href=# id=nav-toggle><i class=kube-menu></i></a></div></div><div class=hide-sm id=top><div id=top-brand><a href=/hakoniwa title=home><img src=/hakoniwa/img/hakoniwa/icon-70x70.png></a></div><nav id=top-nav-main><ul><li><a href=/hakoniwa/docs/>箱庭とは</a></li><li><a href=/hakoniwa/prototypes/>プロトタイプモデル</a></li><li><a href=/hakoniwa/technical-links/>技術情報</a></li><li><a href=/hakoniwa/showcase/>ショーケース</a></li><li><a href=/hakoniwa/getting-started/>Getting Started</a></li><li><a href=/hakoniwa/repositories/>リポジトリ</a></li><li><a href=/hakoniwa/contact/>SNS・問合せ先</a></li></ul></nav><nav id=top-nav-extra><ul><li><a href=# class="active language">JP</a></li></ul></nav></div></header><main><div id=main><div id=hero><h1>単体ロボット向けシミュレータ導入手順</h1><p class=hero-lead>.</p></div><div id=kube-component class=content><h3 id=ev3ロボット制御プログラム>EV3ロボット制御プログラム</h3><p>現時点の制御プログラムの開発フォルダは以下のフォルダで，制御プログラムは app.c です．<br>※まだ暫定構成です．</p><p>ARM版のathrill2を利用される場合は，以下のフォルダで作業してください．</p><pre tabindex=0><code>$ ls ev3rt-athrill-ARMv7-A/sdk/OBJ1.1/
app.c    app.h             device_config_mmap.txt  Makefile      memory_mmap.txt  simstart.bash
app.cfg  athrill_mmap.bin  device_config.txt       Makefile.inc  memory.txt       unity_mmap.bin
</code></pre><p>現状は，app.c/main_task で直接制御を行っています．<br>コード断片は以下の通りです．</p><pre tabindex=0><code>    while(1) {

    /**
     * PID controller
     */
#define white 100
#define black 50
        static float lasterror = 0, integral = 0;
        static float midpoint = (white - black) / 2 + black;
        {
            float error = midpoint - ev3_color_sensor_get_reflect(EV3_PORT_1);
            integral = error + integral * 0.3;
            float steer = 0.6 * error + 0.3 * integral + 1 * (error - lasterror);
            ev3_motor_steer(left_motor, right_motor, 10, steer);
            lasterror = error;

            debug_var = ev3_gyro_sensor_get_angle(EV3_PORT_4);

            int distance = ev3_ultrasonic_sensor_get_distance(EV3_PORT_2);
            debug_var2 = distance;
            if (distance &lt;= 100) {
                ev3_motor_stop(left_motor, false);
                ev3_motor_stop(right_motor, false);
           }
        }
        tslp_tsk(100); /* 100msec */

    }
}
</code></pre><p>上記のアプリケーション実装時の注意点として，以下があります．</p><ul><li>ASP(ARM)版の場合<ul><li>ASPは，第二世代カーネルなので，単位はミリ秒です．HRPと同じですね．</li><li>ARM版のathrillは，利用実績が少ないので，命令セットのデコードエラーになる可能性が高いです．</li><li>デコードエラーになった場合は，以下に issue を挙げていただければ対応します．<ul><li><a href=https://github.com/toppers/athrill-target-ARMv7-A.git>https://github.com/toppers/athrill-target-ARMv7-A.git</a></li><li>この際，調査用に頂きたい情報は以下になります．<ol><li>athrillが出力したエラーメッセージ<br>例．CPU(pc=&lt;アドレス>) Exception!!</li><li>エラー発生した箇所のアセンブラ命令コード(objdumpの結果)<br>例．arm-none-eabi-objdump -D asp | less<br>objdumpの出力書式は以下の通りです．<br>&lt;アドレス>: &lt;機械語(16進数) &lt;アセンブラ命令> &lt;オペランド><br>athrillのエラーメッセージ出力されたアドレスについて，上記箇所をレポート頂ければ上記命令の追加対応が可能になります．</li></ol></li></ul></li></ul></li></ul></div></div></main><footer><footer id=footer><nav><ul><li><span>HAKONIWA-WG</span></li></ul></nav><p>&copy; 2019- by Hakoniwa Working-Group, TOPPERS Project</p></footer></footer><script src=/hakoniwa/js/kube.js type=text/javascript></script><script src=/hakoniwa/js/kube.legenda.js type=text/javascript></script><script src=/hakoniwa/js/main.js type=text/javascript></script></body></html>